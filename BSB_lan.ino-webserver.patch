--- BSB_lan.ino.orig    2020-01-21 11:28:42.249968745 +0300
+++ BSB_lan.ino 2020-01-21 11:31:03.261974591 +0300
@@ -460,7 +460,7 @@
 // char _ipstr[20];    // addr in format xxx.yyy.zzz.aaa
 // byte __remoteIP[4] = {0,0,0,0};   // IP address in bin format

-#ifdef LOGGER
+#if defined  LOGGER || defined  WEBSERVER
 #if defined(__SAM3X8E__)
   #include <SD.h>
 #else
@@ -4824,12 +4927,12 @@
         }
         // Got an EOL character
         DebugOutput.println();
-        // perform HTTP-Authentification by reading the remaining client data and look for credentials
-#ifdef USER_PASS_B64

+        // Parsing headers
         char linebuf[80];
         uint8_t charcount=0;
         boolean authenticated=false;
+        boolean gzipaccepted=false;
         memset(linebuf,0,sizeof(linebuf));
         boolean currentLineIsBlank = false;
         while (client.connected()) {
@@ -4843,9 +4946,17 @@
             if (c == '\n') {
               // you're starting a new line
               currentLineIsBlank = true;
-              if (strstr(linebuf,"Authorization: Basic")!=0 && strstr(linebuf,USER_PASS_B64)!=0) {
+              if (strstr(linebuf,F("Accept-encoding:")) != 0 && strstr(linebuf+16, F("gzip")) != 0) {
+                gzipaccepted=true;
+              }
+#ifdef USER_PASS_B64
+        // perform HTTP-Authentification by reading the remaining client data and look for credentials
+              else if (strstr(linebuf,F("Authorization: Basic"))!=0 && strstr(linebuf,USER_PASS_B64)!=0) {
                 authenticated=true;
               }
+#else
+                authenticated=true;
+#endif
               memset(linebuf,0,sizeof(linebuf));
               charcount=0;
             } else if (c != '\r') {
@@ -4867,13 +4978,17 @@
           client.stop();
         }
         // otherwise continue like normal
-#endif

         // Flush any remaining bytes from the client buffer
 //        client.flush();
         // GET / HTTP/1.1 (anforderung website)
         // GET /710 HTTP/1.0 (befehlseingabe)
         String urlString = String(cLineBuffer);
+#ifdef WEBSERVER
+        // Check for HEAD request (for file caching)
+        boolean isHeadRequest = false;
+        if (urlString.substring(0, urlString.indexOf('/')).indexOf("HEAD") != -1 ) isHeadRequest = true;
+#endif
         urlString = urlString.substring(urlString.indexOf('/'), urlString.indexOf(' ', urlString.indexOf('/')));
         DebugOutput.println(urlString);
         urlString.toCharArray(cLineBuffer, MaxArrayElement);
@@ -4918,21 +5033,160 @@
         }
         *p='/';
 #endif
+
+#ifdef WEBSERVER
+        if(!strcmp(p,"/")){
+          urlString = F("index.html");
+        }
+        else
+          urlString = String(p + 1);
+        DebugOutput.println("URL: " + urlString);
+        int mimetype = 0; //unknown MIME type
+        if (urlString.endsWith(F(".html")) || urlString.endsWith(F(".htm"))) mimetype = 1;
+        else if(urlString.endsWith(F(".css"))) mimetype = 2;
+        else if(urlString.endsWith(F(".js"))) mimetype = 3;
+        else if(urlString.endsWith(F(".xml"))) mimetype = 4;
+        else if(urlString.endsWith(F(".txt"))) mimetype = 5;
+        else if(urlString.endsWith(F(".jpg"))) mimetype = 101;
+        else if(urlString.endsWith(F(".gif"))) mimetype = 102;
+        else if(urlString.endsWith(F(".svg"))) mimetype = 103;
+        else if(urlString.endsWith(F(".png"))) mimetype = 104;
+        else if(urlString.endsWith(F(".gz"))) mimetype = 201;
+        // You can add more MIME types here
+
+        if(mimetype)  {
+          File dataFile = NULL;
+          boolean gzippedfile = false;
+          if (gzipaccepted) dataFile = SD.open(urlString + ".gz");
+          if (dataFile) {
+            gzippedfile = true;
+          }
+          else
+            dataFile = SD.open(urlString);
+          // if the file is available, read from it:
+          if (dataFile) {
+            DebugOutput.print(F("file opened from SD: ")); DebugOutput.println(urlString);
+            client.print(F("HTTP/1.1 200 OK\nContent-Type: "));
+            switch(mimetype){
+              case 1: client.println(F("text/html")); break;
+              case 2: client.println(F("text/css")); break;
+              case 3: client.println(F("application/x-javascript")); break;
+              case 4: client.println(F("application/xml")); break;
+              // case 5 below
+              case 101: client.println(F("image/jpeg")); break;
+              case 102: client.println(F("image/gif")); break;
+              case 103: client.println(F("image/svg")); break;
+              case 104: client.println(F("image/png")); break;
+              case 201: client.println(F("application/x-gzip")); break;
+              case 5:
+              default: client.println(F("text"));
+            }
+
+            client.print(F("Content-Length: ")); client.println(dataFile.size());
+            client.println(F("Cache-Control: max-age=84400, must-revalidate"));
+            if(gzippedfile) client.println(F("Content-Encoding: gzip"));
+            dir_t d;
+            if (dataFile.dirEntry(&d)) {
+              String monthname;
+              String downame;
+              uint16_t lastWrtYr =  (FAT_YEAR(d.lastWriteDate));
+              byte monthval = FAT_MONTH(d.lastWriteDate);
+              byte dayval = FAT_DAY(d.lastWriteDate);
+              switch (dayofweek((uint8_t)dayval, (uint8_t)monthval, lastWrtYr))
+              {
+                case 1: downame = F("Mon"); break;
+                case 2: downame = F("Tue"); break;
+                case 3: downame = F("Wed"); break;
+                case 4: downame = F("Thu"); break;
+                case 5: downame = F("Fri"); break;
+                case 6: downame = F("Sat"); break;
+                case 7: downame = F("Sun"); break;
+                default: downame = F("ERR"); break;
+              }
+
+              switch (monthval)
+              {
+                case 1: monthname = F("Jan"); break;
+                case 2: monthname = F("Feb"); break;
+                case 3: monthname = F("Mar"); break;
+                case 4: monthname = F("Apr"); break;
+                case 5: monthname = F("May"); break;
+                case 6: monthname = F("Jun"); break;
+                case 7: monthname = F("Jul"); break;
+                case 8: monthname = F("Aug"); break;
+                case 9: monthname = F("Sep"); break;
+                case 10: monthname = F("Oct"); break;
+                case 11: monthname = F("Nov"); break;
+                case 12: monthname = F("Dec"); break;
+                default: monthname = F("ERR"); break;
+              }
+
+              client.println("Last-Modified: " +
+                             downame + ", " +
+                             (dayval < 10 ? "0" : "") + dayval + " " +
+                             monthname + " " +
+                             lastWrtYr + " " +
+                             (FAT_HOUR(d.lastWriteTime) < 10 ? "0" : "") + FAT_HOUR(d.lastWriteTime) +
+                             (FAT_MINUTE(d.lastWriteTime) < 10 ? ":0" : ":") + FAT_MINUTE(d.lastWriteTime) +
+                             (FAT_SECOND(d.lastWriteTime) < 10 ? ":0" : ":") + FAT_SECOND(d.lastWriteTime) + " GMT");
+            }
+            client.println();
+            if (!isHeadRequest) {
+              int logbuflen = 512;
+              byte loglineBuf[logbuflen];
+              int chars_read = dataFile.read(&loglineBuf , logbuflen);
+              while (chars_read == logbuflen) {
+                client.write(loglineBuf, logbuflen);
+                chars_read = dataFile.read(&loglineBuf , logbuflen);
+              }
+              if (chars_read > 0) client.write(loglineBuf, chars_read);
+            }
+
+            DebugOutput.println(isHeadRequest?(String)"HEAD":(String)"GET" + " request received");
+
+            dataFile.close();
+          }
+          else
+          {
+          // simply print the website if no index.html on SD card
+            if(!strcmp(p,"/")){
+              webPrintSite();
+              break;
+            }
+            client.print(F("HTTP/1.1 404 Not Found\nContent-Type: text/html\n\n<h2>File not found!</h2><br>File name: "));
+            client.println(urlString);
+
+          }
+          client.flush();
+          break;
+        }
+#endif
+
         if (p[1] != 'J') {
           client.flush();
         }
+#ifndef WEBSERVER
         // simply print the website
         if(!strcmp(p,"/")){
           webPrintSite();
           break;
         }
+#endif

         // Answer to unknown requests
-        if(!isdigit(p[1]) && strchr("ABCDEGHIJKLMNOPQRSTUVXY",p[1])==NULL){
+        if(!isdigit(p[1]) && strchr("ABCDEGHIJKLMNOPQRSTUVWXY",p[1])==NULL){
           webPrintHeader();
           webPrintFooter();
           break;
         }
+
+        //Send HTML pages without header and footer (For external interface)
+        boolean needFullHTML = true;
+        if(p[1]=='W'){
+          p++;
+          needFullHTML = false;
+        }
+
         // setting verbosity level
         if(p[1]=='V'){
           p+=2;
@@ -5169,7 +5423,7 @@
         }

         if(p[1]=='Q') {
-          webPrintHeader();
+          if(needFullHTML) webPrintHeader();

           client.print(F(MENU_TEXT_QSC "...<BR>"));
           if (bus_type == 0) {
@@ -5347,7 +5601,7 @@

           client.println(F("<BR>" MENU_TEXT_QFE ".<BR>"));
           bus.setBusType(bus_type, myAddr, destAddr);   // return to original destination address
-          webPrintFooter();
+          if(needFullHTML) webPrintFooter();
           break;
         }

@@ -5754,7 +6008,7 @@
         }
 #endif
         if (p[1]=='C'){ // dump configuration
-          webPrintHeader();
+          if(needFullHTML) webPrintHeader();
           client.println(F(MENU_TEXT_CFG "<BR><BR>"));
 //          client.println(F("BSB pins: "));
 //          client.println(bus);
@@ -5916,7 +6170,7 @@
           #endif

           client.println(F("<BR>"));
-          webPrintFooter();
+          if(needFullHTML) webPrintFooter();

 #if defined(__AVR__)
           DebugOutput.println(F("EEPROM dump:"));
@@ -7029,7 +7283,7 @@
     }
   }

-#ifdef LOGGER
+#if defined LOGGER || defined WEBSERVER
   // disable w5100 while setting up SD
   pinMode(10,OUTPUT);
   digitalWrite(10,HIGH);
